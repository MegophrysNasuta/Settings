{
    "attribs": {
        "isActive": "no",
        "isFolder": "no"
    },
    "type": "script",
    "name": "Magi",
    "packageName": null,
    "script": "Megophrys.Magi = (Megophrys.Magi or {})\nlocal Magi = Megophrys.Magi\nMagi.element = (Magi.element or 'air')\nMagi.skipTransfix = (Magi.skipTransfix or false)\nMagi.targetTransfixed = (Magi.targetTransfixed or false)\n\nMagi.staffCasts = {\n  earth = 'dissolution',\n  fire = 'scintilla',\n  air = 'lightning',\n  water = 'horripilation',\n}\n\nMegophrys.Magi.onConnect = function()\n  sendAll('simultaneity', 'bind all', 'fortify all')\n  sendAll(\n    'unwield all',\n    'remove armour',\n    'put armour in pack370332',\n    'get staff217211 from pack370332',\n    'wield staff217221 left',\n    'wield shield268649 right'\n  )\nend\n\nMegophrys.Magi.makeClassToolbars = function()\n  Megophrys.magiToolbar = Geyser.Container:new({\n    name='magi_toolbar',\n    x=270, y=0, width=270, height=60\n  })\n\n  Magi.elemLabel = Geyser.Label:new({\n    name='elem_label',\n    x=0, y=0, width=100, height=20,\n    message='Element:'\n  }, Megophrys.magiToolbar)\n  Magi.elemLabel:setFontSize(11)\n  Magi.earthButton = Geyser.Label:new({\n    name='earth_button',\n    x=100, y=0, width=42, height=20,\n  }, Megophrys.magiToolbar)\n  Magi.earthButton:setFontSize(11)\n  Magi.fireButton = Geyser.Label:new({\n    name='fire_button',\n    x=142, y=0, width=42, height=20,\n  }, Megophrys.magiToolbar)\n  Magi.fireButton:setFontSize(11)\n  Magi.airButton = Geyser.Label:new({\n    name='air_button',\n    x=184, y=0, width=42, height=20,\n  }, Megophrys.magiToolbar)\n  Magi.airButton:setFontSize(11)\n  Magi.waterButton = Geyser.Label:new({\n    name='water_button',\n    x=226, y=0, width=42, height=20,\n  }, Megophrys.magiToolbar)\n  Magi.waterButton:setFontSize(11)\n\n  Magi.nextGolemMoveLabel = Geyser.Label:new({\n    name='next_golem_move_label',\n    x=0, y=20, width=100, height=20,\n    message='Golem will:'\n  }, Megophrys.magiToolbar)\n  Magi.nextGolemMoveLabel:setFontSize(11)\n  Magi.nextGolemMoveButton = Geyser.Label:new({\n    name='next_golem_move',\n    x=100, y=20, width=170, height=20,\n  }, Megophrys.magiToolbar)\n  Magi.nextGolemMoveButton:setFontSize(11)\n\n  Magi.golemSmashLabel = Geyser.Label:new({\n    name='golem_smash_label',\n    x=0, y=40, width=100, height=20,\n    message='Smashing:'\n  }, Megophrys.magiToolbar)\n  Magi.golemSmashLabel:setFontSize(11)\n  Magi.golemSmashButton = Geyser.Label:new({\n    name='golem_smash_move',\n    x=100, y=40, width=170, height=20,\n  }, Megophrys.magiToolbar)\n  Magi.golemSmashButton:setFontSize(11)\nend\n\nMegophrys.Magi.setMode = function()\n  local Magi = Megophrys.Magi\n  local killStrat = Megophrys.killStrat\n\n  Megophrys.specialMoveButton:echo(\n    'Embed Focus',\n    Megophrys.fgColors[killStrat],\n    'c'\n  )\n\n  if killStrat == 'denizen' then\n    Megophrys.nextMoveButton:echo('Staffcast', Megophrys.fgColors[killStrat], 'c')\n    Magi.nextGolemMoveButton:echo('Squeeze', Megophrys.fgColors[killStrat], 'c')\n    Magi.golemSmashButton:echo('N/A', 'grey', 'c')\n    Magi.setElement('air')\n    Magi.followUp = 'golem squeeze &tar'\n    cecho('\\n<cyan>Auto-attacks will be staffcasts'..\n          '\\nElement: '.. Magi.element ..\n          '\\nFollow up: '.. Magi.followUp ..\n          '\\nTarget is: '.. target ..'\\n')\n  elseif killStrat == 'raid' then\n    Magi.setElement('earth')\n    if Magi.skipTransfix then\n      Megophrys.nextMoveButton:echo('Staffcast', Megophrys.fgColors[killStrat], 'c')\n    else\n      Megophrys.nextMoveButton:echo('Transfix', Megophrys.fgColors[killStrat], 'c')\n    end\n    Magi.nextGolemMoveButton:echo('Timeflux', Megophrys.fgColors[killStrat], 'c')\n    Magi.followUp = 'golem timeflux &tar'\n    cecho('\\n<cyan>Auto-attacks will be staffcasts'..\n          '\\nElement: '.. Magi.element ..\n          '\\nFollow up: '.. Magi.followUp ..\n          '\\nTarget is: '.. target ..'\\n')\n  elseif killStrat == 'pummel' then\n    Megophrys.nextMoveButton:echo('Staffstrike', Megophrys.fgColors[killStrat], 'c')\n    Magi.nextGolemMoveButton:echo('Timeflux', Megophrys.fgColors[killStrat], 'c')\n    cecho('\\n<cyan>Magi PvP (Ice) mode activated!')\n\n    Megophrys.targetTorso = false\n    Megophrys.resetTargetWounds()\n    Magi.setElement('air', 'first strike')\n    Magi.followUp = 'golem timeflux &tar'\n\n    cecho('\\n<cyan>Auto-attacks will be staffstrikes'..\n          '\\nElement: '.. Magi.element ..\n          '\\nFollow up: '.. Magi.followUp ..\n          '\\nTarget is: '.. target ..\n          '\\n  on limb: '.. Megophrys.targetLimb)\n  elseif killStrat == 'fiyah' then\n    Megophrys.nextMoveButton:echo('Staffstrike', Megophrys.fgColors[killStrat], 'c')\n    Magi.nextGolemMoveButton:echo('Timeflux', Megophrys.fgColors[killStrat], 'c')\n    cecho('\\n<cyan>Magi PvP (Fire) mode activated!')\n\n    Megophrys.targetTorso = false\n    Megophrys.resetTargetWounds()\n    Magi.setElement('air', 'first strike')\n    Magi.followUp = 'golem timeflux '.. target\n\n    cecho('\\n<cyan>Auto-attacks will be staffstrikes'..\n          '\\nElement: '.. Magi.element ..\n          '\\nFollow up: '.. Magi.followUp ..\n          '\\nTarget is: '.. target ..\n          '\\n  on limb: '.. Megophrys.targetLimb)\n    sendAll('setalias nextAction cast efreeti', 'queue addclear eqbal nextAction')\n  end\n\n  if killStrat ~= 'denizen' then Magi.setGolemStrat() end\nend\n\nMegophrys.Magi.subMode = function(n)\n  if n == 1 then\n    Magi.setElement('earth')\n  elseif n == 2 then\n    Magi.setElement('fire')\n  elseif n == 3 then\n    Magi.setElement('air')\n  elseif n == 4 then\n    Magi.setElement('water')\n  else\n    error('Bad sub mode: '.. n ..'!')\n  end\nend\n\nMegophrys.Magi.doSpecial = function() send('embed focus') end\n\nMegophrys.Magi.toggleOne = Magi.toggleSkipTransfix\nMegophrys.Magi.toggleFive = Magi.toggleGolemSmashTarget\n\nMegophrys.Magi.nextAttack = function()\n  local Magi = Megophrys.Magi\n  local killStrat = Megophrys.killStrat\n  local staffCasts = Magi.staffCasts\n  local setNextAttack = 'setalias nextAttack '\n  if not wsys.aff.stupidity then\n    setNextAttack = setNextAttack .. 'stand / '\n  end\n\n  local staffSpell = staffCasts[Magi.element]\n  if killStrat == 'denizen' then\n    Megophrys.nextMoveButton:echo('Staffcast', Megophrys.fgColors[killStrat], 'c')\n    sendAll((setNextAttack ..'cast dilation at &tar / staffcast '.. staffSpell \n             ..' at &tar / golem squeeze &tar'),\n            'queue addclear eqbal nextAttack')\n  else\n    Magi.setGolemStrat()\n    local tarAff = affstrack.score\n\n    if killStrat == 'raid' then\n      if not Megophrys.Magi.targetTransfixed then\n        Megophrys.nextMoveButton:echo('Transfix', Megophrys.fgColors[killStrat], 'c')\n        sendAll(setNextAttack ..'cast transfix at &tar',\n                'queue addclear eqbal nextAttack')\n      elseif (Megophrys.targetHits or 0) % 4 == 0 then\n        Megophrys.targetHits = 1\n        Megophrys.Magi.targetTransfixed = false\n        Megophrys.nextMoveButton:echo('Transfix', Megophrys.fgColors[killStrat], 'c')\n        sendAll(setNextAttack ..'cast transfix at &tar',\n                'queue addclear eqbal nextAttack')\n      else\n        Megophrys.nextMoveButton:echo('Staffcast', Megophrys.fgColors[killStrat], 'c')\n        sendAll(setNextAttack ..'staffcast '.. staffSpell ..' at &tar',\n                'queue addclear eqbal nextAttack')\n      end\n      Megophrys.targetHits = Megophrys.targetHits + 1\n    else\n      local prepStatus = Megophrys.nextLimbPrepAttack('deepfreeze', 91, 84)\n      local targetLimb = prepStatus.targetLimb\n      local targetTorso = prepStatus.targetTorso\n      local cmd = 'staffstrike &tar with '.. Magi.element\n      Megophrys.nextMoveButton:echo('Staffstrike', Megophrys.fgColors[killStrat], 'c')\n\n      local airBendForRebound = (\n          ak.defs.rebounding or\n          (Megophrys.targetHits == 0)  -- first hit in case of rebounding\n      )\n      local airBendForUnderPrep = (\n          (targetTorso and prepStatus.torsoIsUnderPrepped) or\n          (not targetTorso and (prepStatus.limbIsUnderPrepped or\n                                prepStatus.otherLimbIsUnderPrepped))\n      )\n      if airBendForRebound then\n        Magi.setElement('air', 'rebounding')\n      elseif airBendForUnderPrep then\n        Magi.setElement('air', 'underprep')\n      else\n        Magi.setElement('earth', 'limb prep')\n      end\n\n      if prepStatus.limbIsPrepped then\n        if ak.defs.rebounding then\n          Magi.setElement('air', 'rebounding')\n        else\n          Magi.setElement('earth', 'limb prep')\n        end\n      elseif prepStatus.prepConditionsMet then\n        if killStrat == 'fiyah' then\n          Megophrys.nextMoveButton:echo('Dehydrate', Megophrys.fgColors[killStrat], 'c')\n          Magi.followUp = 'golem dehydrate '.. target\n          Megophrys.targetHits = 0\n        end\n        Magi.setElement('air', 'proning')\n      elseif Megophrys.killPreConditionsMet then\n        if tarAff[\"prone\"] == 100 then\n          if killStrat == 'pummel' then\n            Magi.setElement('water', 'freezing')\n          elseif killStrat == 'fiyah' then\n            Magi.setElement('fire', 'burning')\n          end\n        else\n          Magi.setElement('air', 'proning')\n        end\n      end\n\n      if killStrat == 'pummel' then\n        if Megophrys.killPreConditionsMet and tarAff[\"shivering\"] < 80 then\n          sendAll('clearqueue all', 'cast deepfreeze')\n          Megophrys.killPreConditionsMet = false\n          Megophrys.nextMoveButton:echo('Hypothermia', Megophrys.fgColors[killStrat], 'c')\n          return\n        elseif tarAff[\"shivering\"] > 80 then\n          -- kill condition met: pummel to death\n          Megophrys.priorityLabel:echo('<center>Priority: PUMMEL</center>')\n          Magi.setElement('water', 'freezing')\n          cmd = 'staffstrike &tar with '.. Magi.element\n          if tarAff[\"frozen\"] < 80 then\n            Magi.followUp = 'golem hypothermia &tar'\n          else\n            Magi.followUp = 'golem pummel &tar'\n          end\n          Megophrys.nextMoveButton:echo('Pummel', Megophrys.fgColors[killStrat], 'c')\n          targetTorso = true\n        end\n      elseif killStrat == 'fiyah' then\n        if tarAff[\"dehydrated\"] > 80 then\n          Megophrys.priorityLabel:echo('<center>Priority: DESTROY</center>')\n          Magi.setElement('fire', 'burning')\n          cmd = 'staffstrike &tar with '.. Magi.element\n          if (Megophrys.targetHits or 0) % 3 == 0 then\n            Megophrys.nextMoveButton:echo('Conflagrate', Megophrys.fgColors[killStrat], 'c')\n            Magi.followUp = 'golem destroy &tar'\n          elseif (Megophrys.targetHits or 0) % 3 == 1 then\n            Megophrys.nextMoveButton:echo('Heat / Scorch', Megophrys.fgColors[killStrat], 'c')\n            Magi.followUp = 'golem conflagrate &tar'\n          else\n            Megophrys.nextMoveButton:echo('Try Destroy', Megophrys.fgColors[killStrat], 'c')\n            Magi.followUp = 'golem destabilise heat / golem scorch &tar'\n          end\n          targetTorso = true\n        end\n      end\n\n      if killStrat == 'pummel' or killStrat == 'fiyah' then\n        if targetLimb and not targetTorso then\n          cmd = cmd .. ' ' .. targetLimb .. ' leg'\n        else\n          cmd = cmd .. ' torso'\n        end\n        sendAll(\n          setNextAttack .. cmd .. '/' .. Magi.followUp,\n          'queue addclear eqbal nextAttack'\n        )\n        Megophrys.targetHits = Megophrys.targetHits + 1\n      end\n    end\n  end\nend\n\nMagi.resetElementButtonStyles = function()\n  Magi.earthButton:echo('Ea', 'white', 'c')\n  Magi.fireButton:echo('Fi', 'white', 'c')\n  Magi.airButton:echo('Ai', 'white', 'c')\n  Magi.waterButton:echo('Wa', 'white', 'c')\nend\n\nMagi.setElement = function(element, reason)\n  local elem = tostring(element):lower()\n\n  if elem == 'earth' then\n    button = Magi.earthButton\n  elseif elem == 'fire' then\n    button = Magi.fireButton\n  elseif elem == 'air' then\n    button = Magi.airButton\n  elseif elem == 'water' then\n    button = Magi.waterButton\n  else\n    cecho('\\n<red>Unknown element: '.. elem ..' (ignored)\\n')\n  end\n\n  Magi.element = elem\n  Magi.resetElementButtonStyles()\n  button:echo(string.title(string.sub(elem, 1, 2)), Megophrys.fgColors[Megophrys.killStrat], 'c')\n\n  if reason then\n    cecho('\\n<cyan>Element set to: '.. Magi.element ..' ('.. reason ..')\\n')\n  else\n    cecho('\\n<cyan>Element set to: '.. Magi.element ..'\\n')\n  end\nend\n\nMagi.setGolemStrat = function()\n  Magi.golemSmashTarget = 'arms'\n  Magi.golemSmashButton:echo('Arms', Megophrys.fgColors[Megophrys.killStrat], 'c')\n  if tarAff[\"timeflux\"] > 80 then\n    if Megophrys.killStrat == 'fiyah' then\n      if Magi.infernoDown then\n        Magi.followUp = 'golem inferno'\n      else\n        Magi.followUp = 'golem scorch '.. target\n      end\n      Magi.nextGolemMoveButton:echo('Scorch', Megophrys.fgColors[killStrat], 'c')\n    else\n      Magi.nextGolemMoveButton:echo('Smash', Megophrys.fgColors[killStrat], 'c')\n      Magi.followUp = 'golem smash '.. target .. ' '.. Magi.golemSmashTarget\n    end\n  else\n    Magi.nextGolemMoveButton:echo('Timeflux', Megophrys.fgColors[killStrat], 'c')\n    Magi.followUp = 'golem timeflux '.. target\n  end\nend\n\nMagi.lostInferno = function()\n  Magi.infernoDown = true\n  Magi.nextGolemMoveButton:echo('Inferno', Megophrys.fgColors[Megophrys.killStrat], 'c')\nend\n\nMagi.targetIsTransfixed = function()\n  Magi.targetTransfixed = true\n  Magi.nextMoveButton:echo('Staffcast', Megophrys.fgColors[Megophrys.killStrat], 'c')\nend\n\nMagi.targetLostTimeflux = function()\n  Magi.nextGolemMoveButton:echo('Timeflux', Megophrys.fgColors[Megophrys.killStrat], 'c')\nend\n\nMagi.toggleGolemSmashTarget = function()\n  local killStrat = Megophrys.killStrat\n  if Magi.golemSmashTarget and Magi.golemSmashTarget == 'arms' then\n    cecho('\\n<cyan>Golem will smash legs!\\n')\n    Magi.golemSmashButton:echo('Legs', Megophrys.fgColors[killStrat], 'c')\n    Magi.golemSmashTarget = 'legs'\n  else\n    cecho('\\n<cyan>Golem will smash arms!\\n')\n    Magi.golemSmashButton:echo('Arms', Megophrys.fgColors[killStrat], 'c')\n    Magi.golemSmashTarget = 'arms'\n  end\nend\n\nMagi.toggleSkipTransfix = function()\n  local killStrat = Megophrys.killStrat\n  Magi.skipTransfix = not Magi.skipTransfix\n\n  if Megophrys.killStrat == 'raid' then\n    if Magi.skipTransfix then\n      Megophrys.nextMoveButton:echo('Staffcast', Megophrys.fgColors[killStrat], 'c')\n    else\n      Megophrys.nextMoveButton:echo('Transfix', Megophrys.fgColors[killStrat], 'c')\n    end\n  end\n\n  if Magi.skipTransfix then\n    cecho('\\n<cyan>Skipping transfix! (Only doing damage.)\\n')\n  else\n    cecho('\\n<cyan>Adding transfix to raid rotation.\\n')\n  end\nend\n",
    "eventHandlerList": null
}