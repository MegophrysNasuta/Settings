{
    "attribs": {
        "isActive": "yes",
        "isFolder": "no"
    },
    "type": "script",
    "name": "Psion",
    "packageName": null,
    "script": "Megophrys.Psion = (Megophrys.Psion or {})\nlocal Psion = Megophrys.Psion\n\nMegophrys.Psion.onConnect = function()\n  sendAll(\n    'unwield all',\n    'remove armour',\n    'put armour in pack370332',\n    'wield shield268649 right'\n  )\nend\n\nMegophrys.Psion.setMode = function()\n  local Psion = Megophrys.Psion\n  local killStrat = Megophrys.killStrat\n\n  if killStrat == 'denizen' then\n    Megophrys.Psion.setWeavePrep('clumsiness')\n    Megophrys.nextMoveButton:echo('BONK!', Megophrys.fgColors[killStrat], 'c')\n  elseif killStrat == 'los' then\n    Megophrys.nextMoveButton:echo('Destruction', Megophrys.fgColors[killStrat], 'c')\n  else\n    Megophrys.Psion.setWeavePrep('paralysis')\n    Megophrys.nextMoveButton:echo('<i>*SLAP*</i>', Megophrys.fgColors[killStrat], 'c')\n  end\n\n  if killStrat == 'los' then\n    Megophrys.psionToolbar:hide()\n  else\n    Megophrys.psionToolbar:show()\n  end\n\n  Megophrys.specialMoveButton:echo(\n    'Wavesurge (ESC)',\n    Megophrys.fgColors[killStrat],\n    'c'\n  )\nend\n\nMegophrys.Psion.doSpecial = function() send('enact wavesurge') end\n\nMegophrys.Psion.makeClassToolbars = function()\n  Megophrys.psionToolbar = Geyser.Container:new({\n    name='psion_toolbar',\n    x=270, y=0, width=270, height=60\n  })\n\n  Psion.wpLabel = Geyser.Label:new({\n    name='wp_label',\n    x=0, y=0, width=100, height=20,\n    message='Prepared:'\n  }, Megophrys.psionToolbar)\n  Psion.wpLabel:setFontSize(11)\n  Psion.weavePrepButton = Geyser.Label:new({\n    name='weave_prep_button',\n    x=100, y=0, width=170, height=20,\n  }, Megophrys.psionToolbar)\n  Psion.weavePrepButton:setFontSize(11)\n\n  Psion.nextPsiMoveLabel = Geyser.Label:new({\n    name='next_psi_move_label',\n    x=0, y=20, width=100, height=20,\n    message='Bonus atk:'\n  }, Megophrys.psionToolbar)\n  Psion.nextPsiMoveLabel:setFontSize(11)\n  Psion.nextPsiMoveButton = Geyser.Label:new({\n    name='next_psi_move',\n    x=100, y=20, width=170, height=20,\n  }, Megophrys.psionToolbar)\n  Psion.nextPsiMoveButton:setFontSize(11)\n\n  Psion.setMode('denizen')\n  Megophrys.updatePrepGauges()\nend\n\nMegophrys.Psion.setWeavePrep = function(prep)\n  local weavePrepMap = {\n    paralysis = 'disruption',\n    haemophilia = 'laceration',\n    clumsiness = 'dazzle',\n    epilepsy = 'rattle',\n    asthma = 'vapours'\n  }\n\n  Megophrys.Psion.weavePrep = weavePrepMap[prep:lower()]\n  if Megophrys.Psion.weavePrep then\n    cecho(('\\n<cyan>Set weave prep to '.. Megophrys.Psion.weavePrep\n           ..' ('.. prep ..')\\n'))\n    Megophrys.givingAffs = {prep}\n    Megophrys.Psion.weavePrepButton:echo(prep:lower():title(),\n                                   Megophrys.fgColors[Megophrys.killStrat],\n                                   'c')\n  end\nend\n\nMegophrys.Psion.nextAttack = function()\n  local Psion = Megophrys.Psion\n  local chanceToMouthOff = 0\n  local imSoClever = ''\n  local killStrat = Megophrys.killStrat\n  local nextWeave = 'overhand &tar'\n  local nextPsi = ''\n  local setNextAttack = 'setalias nextAttack '\n  local targetAffs = affstrack.score\n  local targetHits = Megophrys.targetHits or 0\n  local targetLimbSet = (Megophrys.targetLimbSet or 'leg')\n  local uiColor = Megophrys.fgColors[killStrat]\n\n  local unweavingBody = (ak.psion.unweaving.body or 0)\n  local unweavingMind = (ak.psion.unweaving.mind or 0)\n  local unweavingSpirit = (ak.psion.unweaving.spirit or 0)\n\n  local tarAff = affstrack.score\n\n  if not wsys.aff.stupidity then\n    setNextAttack = setNextAttack .. 'stand / '\n  end\n\n  if killStrat == 'denizen' then\n    setNextAttack = (setNextAttack .. 'weave whirlwind &tar / '..\n                                      'weave barbedblade &tar / ')\n  elseif killStrat == 'los' then\n    if Psion.clarityUp then\n      send('enact clarity')\n    else\n      send('enact destruction '.. target ..' '.. Megophrys.LOSDirection)\n    end\n  else\n    if ak.defs.shield then\n      Megophrys.nextMoveButton:echo('Cleave Shield', Megophrys.fgColors[killStrat], 'c')\n      nextWeave = 'cleave &tar'\n    else\n      if tarAff[\"paralysis\"] < 90 then\n        Megophrys.Psion.setWeavePrep('paralysis')\n      elseif not tarAff[\"asthma\"] < 60 then\n        Megophrys.Psion.setWeavePrep('asthma')\n      elseif tarAff[\"clumsiness\"] < 40 then\n        Megophrys.Psion.setWeavePrep('clumsiness')\n      else\n        Megophrys.Psion.setWeavePrep('haemophilia')\n      end\n\n      local targetManaPct = (ak.currentmana or 0) / (ak.maxmana or 1)\n      if targetManaPct <= 0.3 then\n        nextPsi = 'excise'\n        nextWeave = 'deathblow &tar'\n        imSoClever = 'say You cannot resist!'\n        chanceToMouthOff = 1\n      elseif ((unweavingBody > 3 and unweavingMind > 3) or\n              (unweavingBody > 3 and unweavingSpirit > 3) or\n              (unweavingMind > 3 and unweavingSpirit > 3)) then\n        nextPsi = 'deconstruct'\n        nextWeave = 'deathblow &tar'\n        imSoClever = 'say Another enemy unmade. Hah!'\n        chanceToMouthOff = 1\n      elseif unweavingBody > 4 and unweavingMind < 1 then\n        nextWeave = 'invert &tar body spirit'\n        imSoClever = ''\n        chanceToMouthOff = 0\n      elseif unweavingMind > 4 and unweavingBody < 1 then\n        nextWeave = 'invert &tar mind spirit'\n        imSoClever = ''\n        chanceToMouthOff = 0\n      elseif unweavingSpirit > 4 then\n        nextWeave = 'flurry &tar'\n        imSoClever = 'say *forcefully Die, heretic!'\n        chanceToMouthOff = 0.2\n      elseif targetHits % 2 == 0 then\n        if tarAff[\"unweavingbody\"] < 80 then\n          nextWeave = 'unweave &tar body'\n          table.insert(Megophrys.givingAffs, 'unweavingbody')\n        elseif tarAff[\"unweavingmind\"] < 80 then\n          nextWeave = 'unweave &tar mind'\n          table.insert(Megophrys.givingAffs, 'unweavingmind')\n        else\n          if targetLimbSet == 'leg' then\n            nextWeave = 'hamstring &tar'\n            imSoClever = 'warcry'\n            chanceToMouthOff = 0.1\n            table.insert(Megophrys.givingAffs, 'hamstring')\n          else\n            nextWeave = 'sever &tar'\n            imSoClever = 'warcry'\n            chanceToMouthOff = 0.1\n            table.insert(Megophrys.givingAffs, 'clumsiness')\n          end\n        end\n      elseif tarAff[\"impatience\"] < 70 then\n        chanceToMouthOff = 0.4\n        if tarAff[\"prone\"] == 100 or lb[target].hits.head > 100 then\n          nextWeave = 'overhand &tar'\n          imSoClever = 'say BONK!!'\n          table.insert(Megophrys.givingAffs, 'impatience')\n        else\n          nextWeave = 'backhand &tar'\n          imSoClever = 'say SLAP!!'\n          table.insert(Megophrys.givingAffs, 'stupidity')\n          table.insert(Megophrys.givingAffs, 'dizziness')\n        end\n      elseif tarAff[\"impatience\"] > 69 and tarAff[\"bloodfire\"] > 80 then\n        nextWeave = 'exsanguinate &tar'\n        imSoClever = 'say *forcefully Die, heretic!'\n        chanceToMouthOff = 0.2\n        table.insert(Megophrys.givingAffs, 'nausea')\n        if (ak.bleeding or 0) > 150 then\n          table.insert(Megophrys.givingAffs, 'anorexia')\n        end\n      elseif (tarAff[\"impatience\"] > 69 and tarAff[\"bloodfire\"] > 80 and \n                tarAff[\"anorexia\"] > 69) then\n        if tarAff[\"unweavingbody\"] < 80 then\n          nextWeave = 'unweave &tar body'\n          table.insert(Megophrys.givingAffs, 'unweavingbody')\n        elseif tarAff[\"unweavingmind\"] < 80 then\n          nextWeave = 'unweave &tar mind'\n          table.insert(Megophrys.givingAffs, 'unweavingmind')\n        else\n          nextWeave = 'deathblow &tar'\n          if not Megophrys.givingAffs:contains('asthma') then\n            table.insert(Megophrys.givingAffs, 'asthma')\n          end\n        end\n        imSoClever = ''\n        chanceToMouthOff = 0\n      else\n        nextWeave = 'deathblow &tar'\n        imSoClever = 'warcry'\n        chanceToMouthOff = 0.1\n        if not Megophrys.givingAffs:contains('asthma') then\n          table.insert(Megophrys.givingAffs, 'asthma')\n        end\n      end\n    end\n  end\n\n  if tonumber(ak.psion.transcend or 0) > 99 then\n    if killStrat == 'denizen' then\n      nextPsi = 'shatter'\n    else\n      if (ak.bleeding or 0) > 150 then\n        nextPsi = 'combustion'\n        table.insert(Megophrys.givingAffs, 'bloodfire')\n      elseif tarAff[\"mindravaged\"] > 80 and (\n            tarAff[\"impatience\"] > 80 and tarAff[\"stupidity\"] > 80 and (\n                tarAff[\"dizziness\"] > 80 or tarAff[\"unweavingmind\"] > 80\n            )) then\n        nextPsi = 'blast'\n        table.insert(Megophrys.givingAffs, 'mindravaged')\n      else\n        if targetHits % 2 == 1 then\n          nextPsi = 'muddle'\n        else\n          nextPsi = 'shatter'\n        end\n      end\n    end\n  end\n\n  if nextPsi ~= '' then\n    setNextAttack = setNextAttack ..'psi '.. nextPsi ..' &tar / '\n  end\n  if Psion.weavePrep ~= '' then\n    setNextAttack = setNextAttack ..'weave prepare '.. Psion.weavePrep ..' / '\n  end\n\n  setNextAttack = setNextAttack ..'weave '.. nextWeave ..' / '\n\n  if killStrat ~= 'denizen' then\n    setNextAttack = setNextAttack ..'contemplate &tar / '\n    if not Psion.lightBindUp then\n      setNextAttack = setNextAttack ..'enact lightbind &tar'\n    end\n  end\n\n  Psion.nextPsiMoveButton:echo(nextPsi or '', uiColor, 'c')\n\n  if imSoClever ~= '' and math.random() < chanceToMouthOff then\n    setNextAttack = setNextAttack ..' / '.. imSoClever\n  end\n\n  sendAll(setNextAttack, 'queue addclear eqbal nextAttack')\n  if not ak.defs.shield then\n    Megophrys.targetHits = targetHits + 1\n  end\n\n  if killStrat ~= 'denizen' then\n    if #Megophrys.givingAffs == 1 then\n      send('pt '.. Megophrys.givingAffs[1] ..' on '.. target)\n    elseif #Megophrys.givingAffs == 2 then\n      send('pt '.. Megophrys.givingAffs[1] ..' and '.. Megophrys.givingAffs[2] ..\n           ' on '.. target)\n    elseif #Megophrys.givingAffs == 3 then\n      send('pt '.. Megophrys.givingAffs[1] ..', '.. Megophrys.givingAffs[2] ..\n           ' and '.. Megophrys.givingAffs[3] ..' on '.. target)\n    end\n  end\nend\n",
    "eventHandlerList": null
}