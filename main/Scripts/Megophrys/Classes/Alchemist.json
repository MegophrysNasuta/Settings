{
    "attribs": {
        "isActive": "yes",
        "isFolder": "no"
    },
    "type": "script",
    "name": "Alchemist",
    "packageName": null,
    "script": "Megophrys.Alchemist = (Megophrys.Alchemist or {})\nlocal Alchemist = Megophrys.Alchemist\nAlchemist.overdraw = false\n\nAlchemist.doSpecial = function() send('educe tin') end\n\nMegophrys.Alchemist.makeClassToolbars = function()\n  Megophrys.alchToolbar = Geyser.Container:new({\n    name='alch_toolbar',\n    x=270, y=0, width=270, height=60\n  })\n\n  Alchemist.humourLabel = Geyser.Label:new({\n    name='humour_label',\n    x=0, y=0, width=100, height=20,\n    message='Humour:'\n  }, Megophrys.alchToolbar)\n  Alchemist.humourLabel:setFontSize(11)\n  Alchemist.melancholicButton = Geyser.Label:new({\n    name='melancholic_button',\n    x=100, y=0, width=42, height=20,\n  }, Megophrys.alchToolbar)\n  Alchemist.melancholicButton:setFontSize(11)\n  Alchemist.cholericButton = Geyser.Label:new({\n    name='choleric_button',\n    x=142, y=0, width=42, height=20,\n  }, Megophrys.alchToolbar)\n  Alchemist.cholericButton:setFontSize(11)\n  Alchemist.sanguineButton = Geyser.Label:new({\n    name='sanguine_button',\n    x=184, y=0, width=42, height=20,\n  }, Megophrys.alchToolbar)\n  Alchemist.sanguineButton:setFontSize(11)\n  Alchemist.phlegmaticButton = Geyser.Label:new({\n    name='phlegmatic_button',\n    x=226, y=0, width=42, height=20,\n  }, Megophrys.alchToolbar)\n  Alchemist.phlegmaticButton:setFontSize(11)\n\n  Alchemist.nextWrackLabel = Geyser.Label:new({\n    name='next_wrack_label',\n    x=0, y=20, width=100, height=20,\n    message='Next wrack: '\n  }, Megophrys.alchToolbar)\n  Alchemist.nextWrackLabel:setFontSize(11)\n  Alchemist.nextWrackButton = Geyser.Label:new({\n    name='next_wrack',\n    x=100, y=20, width=170, height=20,\n  }, Megophrys.alchToolbar)\n  Alchemist.nextWrackButton:setFontSize(11)\n\n  Alchemist.setMode('denizen')\n  Megophrys.updatePrepGauges()\nend\n\nMegophrys.Alchemist.onConnect = function()\n  sendAll(\n    'unwield all',\n    'remove armour',\n    'put armour in pack370332',\n    'get ringmail from pack370332'\n  )\n  tempTimer(3, Megophrys.Alchemist.gearUp)\nend\n\nMegophrys.Alchemist.gearUp = function()\n  sendAll(\n    'wield shield268649 right',\n    'wear ringmail',\n    'wear robes'\n  )\nend\n\nMegophrys.Alchemist.nextAttack = function()\n  local Alchemist = Megophrys.Alchemist\n  local chanceToMouthOff = 0\n  local imSoClever = ''\n  local killStrat = Megophrys.killStrat\n  local nextEduce = ''\n  local nextTemper = ''\n  local nextWrack = ''\n  local targetAffs = affstrack.score\n  local targetHits = Megophrys.targetHits or 0\n  local uiColor = Megophrys.fgColors[killStrat]\n\n  local tarAff = affstrack.score\n  local targetHumour = {}\n  targetHumour.sanguine = (ak.alchemist.humour.sanguine or 0)\n  targetHumour.melancholic = (ak.alchemist.humour.melancholic or 0)\n  targetHumour.choleric = (ak.alchemist.humour.choleric or 0)\n  targetHumour.phlegmatic = (ak.alchemist.humour.phlegmatic or 0)\n\n  local preAlias = 'setalias nextAttack '\n  if killStrat ~= 'denizen' then\n    preAlias = preAlias .. 'homunculus attack &tar / evaluate &tar / '\n  end\n  if not wsys.aff.stupidity then\n    preAlias = preAlias .. 'stand / '\n  end\n\n  local firstAff = nil\n  local secondAff = nil\n  if killStrat == 'denizen' then\n    preAlias = preAlias .. 'throw miasma at &tar / educe magnesium &tar / '\n    nextEduce = 'iron'\n  elseif killStrat == 'los' then\n    local LOSCommand = 'throw'\n    if Megophrys.targetHits % 3 == 0 then\n      LOSCommand = LOSCommand ..' devitalisation '\n    elseif Megophrys.targetHits % 2 == 0 then\n      LOSCommand = LOSCommand ..' incendiary '\n    else\n      LOSCommand = LOSCommand ..' intoxicant '\n    end\n    send(LOSCommand .. Megophrys.LOSDirection)\n  else\n    if ak.defs.shield then\n      Megophrys.nextMoveButton:echo('Educe Copper', Megophrys.fgColors[killStrat], 'c')\n      nextEduce = 'copper'\n    else\n      local targetManaPct = (ak.currentmana or 0) / (ak.maxmana or 1)\n      local targetHealthPct = (ak.currenthealth or 0) / (ak.maxhealth or 1)\n      if targetManaPct <= 0.6 and (targetHealthPct <= 0.6 or \n                                   (targetHealthPct <= 0.66 and targetHumour.choleric > 2) or\n                                   (targetHealthPct <= 0.72 and targetHumour.choleric > 4)) then\n        nextTemper = 'inundate &tar choleric'\n        nextWrack = 'aurify &tar'\n      else\n        if targetHumour.sanguine < 1 then\n          Alchemist.setHumour('sanguine')\n        elseif targetHumour.melancholic < 1 then\n          Alchemist.setHumour('melancholic')\n        elseif targetHumour.phlegmatic < 1 then\n          Alchemist.setHumour('phlegmatic')\n        elseif targetHumour.choleric < 1 then\n          Alchemist.setHumour('choleric')\n        elseif targetHumour.melancholic < 2 then\n          Alchemist.setHumour('melancholic')\n        else\n          Alchemist.setHumour('choleric')\n        end\n\n        local chooseAff = function(ignoreAff)\n          local affPrios = {\n            paralysis = 'sanguine',       -- eat bloodroot\n            impatience = 'melancholic',   -- eat goldenseal\n            asthma = 'phlegmatic',        -- eat kelp\n            clumsiness = 'phlegmatic',    -- eat kelp\n            sensitivity = 'choleric',     -- eat kelp\n            slickness = 'choleric',       -- smoke valerian, eat bloodroot\n            nausea = 'choleric',          -- eat ginseng\n            anorexia = 'melancholic',     -- apply epidermal\n            haemophilia = 'sanguine',     -- eat ginseng\n            recklessness = 'sanguine',    -- eat lobelia, focus\n            stupidity = 'melancholic',    -- eat goldenseal\n            weariness = 'phlegmatic',     -- eat kelp\n          }\n          for aff, humour in pairs(affPrios) do\n            if (ignoreAff ~= aff and\n                targetHumour[humour] > 0 and tarAff[aff] < 80) then\n              return aff\n            end\n          end\n        end\n\n        firstAff = chooseAff()\n        secondAff = chooseAff(firstAff)\n\n        imSoClever = 'warcry'\n        chanceToMouthOff = 0.1\n      end\n    end\n  end\n\n  local setNextAttack = preAlias\n  if nextEduce then\n    setNextAttack = setNextAttack ..'educe '.. nextEduce .. ' &tar / '\n    secondAff = ''\n  end\n\n  local targetIsLocked = (\n    tarAff[\"paralysis\"] > 80 and tarAff[\"anorexia\"] > 80 and tarAff[\"asthma\"] > 80 and\n    tarAff[\"slickness\"] > 80 and tarAff[\"impatience\"] > 80\n  )\n\n  if targetIsLocked then\n    sendAll('wield toxin', 'throw toxin at ground')\n  else\n    setNextAttack = setNextAttack .. (nextTemper or\n                                      'temper &tar '.. Alchemist.humour)\n    table.insert(Megophrys.givingAffs, firstAff)\n    if firstAff then\n      if not secondAff then\n        setNextAttack = setNextAttack ..' / wrack &tar '.. firstAff\n      else\n        setNextAttack = (setNextAttack ..' / truewrack &tar '..\n                         firstAff ..' '.. secondAff)\n        table.insert(Megophrys.givingAffs, secondAff)\n      end\n      Alchemist.nextWrackButton:echo(firstAff ..' '.. secondAff, uiColor, 'c')\n    end\n\n    if wsys.aff.prone then\n      send('stand')\n    else\n      if imSoClever ~= '' and math.random() < chanceToMouthOff then\n        setNextAttack = setNextAttack ..' / '.. imSoClever\n      end\n    end\n\n    sendAll(setNextAttack, 'queue addclear eqbal nextAttack')\n    if not ak.defs.shield then\n      Megophrys.targetHits = targetHits + 1\n    end\n  end\n\n  if killStrat ~= 'denizen' then\n    if #Megophrys.givingAffs == 1 then\n      send('pt '.. Megophrys.givingAffs[1] ..' on '.. target)\n    elseif #Megophrys.givingAffs == 2 then\n      send('pt '.. Megophrys.givingAffs[1] ..' and '.. Megophrys.givingAffs[2] ..\n           ' on '.. target)\n    elseif #Megophrys.givingAffs == 3 then\n      send('pt '.. Megophrys.givingAffs[1] ..', '.. Megophrys.givingAffs[2] ..\n           ' and '.. Megophrys.givingAffs[3] ..' on '.. target)\n    end\n  end\nend\n\nAlchemist.resetHumourButtonStyles = function()\n  Alchemist.melancholicButton:echo('Me', 'white', 'c')\n  Alchemist.cholericButton:echo('Ch', 'white', 'c')\n  Alchemist.sanguineButton:echo('Sa', 'white', 'c')\n  Alchemist.phlegmaticButton:echo('Ph', 'white', 'c')\nend\n\nAlchemist.setHumour = function(humour, reason)\n  local elem = tostring(humour):lower()\n\n  if elem == 'melancholic' then\n    button = Alchemist.melancholicButton\n  elseif elem == 'choleric' then\n    button = Alchemist.cholericButton\n  elseif elem == 'sanguine' then\n    button = Alchemist.sanguineButton\n  elseif elem == 'phlegmatic' then\n    button = Alchemist.phlegmaticButton\n  else\n    cecho('\\n<red>Unknown humour: '.. elem ..' (ignored)\\n')\n  end\n\n  Alchemist.humour = elem\n  Alchemist.resetHumourButtonStyles()\n  button:echo(string.title(string.sub(elem, 1, 2)), Megophrys.fgColors[Megophrys.killStrat], 'c')\n\n  if reason then\n    cecho('\\n<cyan>Humour set to: '.. Alchemist.humour ..' ('.. reason ..')\\n')\n  else\n    cecho('\\n<cyan>Humour set to: '.. Alchemist.humour ..'\\n')\n  end\nend\n\nMegophrys.Alchemist.setMode = function()\n  local Alchemist = Megophrys.Alchemist\n  local killStrat = Megophrys.killStrat\n\n  Alchemist.resetHumourButtonStyles()\n\n  if killStrat == 'denizen' then\n    Megophrys.nextMoveButton:echo('Educe Iron', Megophrys.fgColors[killStrat], 'c')\n  elseif killStrat == 'los' then\n    Megophrys.nextMoveButton:echo('Nocturne', Megophrys.fgColors[killStrat], 'c')\n  else\n    Megophrys.Alchemist.setHumour('sanguine')\n    Megophrys.nextMoveButton:echo('Wrack', Megophrys.fgColors[killStrat], 'c')\n  end\n\n  if killStrat == 'los' then\n    Megophrys.alchToolbar:hide()\n  else\n    Megophrys.alchToolbar:show()\n  end\n\n  Megophrys.specialMoveButton:echo(\n    'Educe Tin',\n    Megophrys.fgColors[killStrat],\n    'c'\n  )\nend\n\nMegophrys.Alchemist.subMode = function(n)\n  if n == 1 then\n    Alchemist.setElement('melancholic')\n  elseif n == 2 then\n    Alchemist.setElement('choleric')\n  elseif n == 3 then\n    Alchemist.setElement('sanguine')\n  elseif n == 4 then\n    Alchemist.setElement('phlegmatic')\n  else\n    error('Bad sub mode: '.. n ..'!')\n  end\nend\n\nMegophrys.Alchemist.toggleOne = function(altMode)\n  if Alchemist.overdraw then\n    Alchemist.overdraw = false\n    cecho('\\n<cyan>No longer overdrawing.\\n')\n  else\n    Alchemist.overdraw = true\n    cecho('\\n<cyan>Overdrawing enabled!\\n')\n  end\nend\n",
    "eventHandlerList": null
}